---
title: "Poisson and Negative Binomial Distributions"
author: Eamonn
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    social: menu
    source_code: embed
runtime: shiny
---
Dashboard
===

```{r global, include=FALSE}

lwd.=3

 my_dnbinom=function(x,mu,alpha){
  m = mu
  k = 1/alpha
  # lgamma is log(gamma)
  a = lgamma(k+x)-lgamma(k)-lgamma(x+1)
  b = x*log(m/(m+k))
  c = -k*log(1+m/k)
  prob = exp(a+b+c)
  prob[x<0] = 0
  prob[prob>1] = 1
  prob[prob<0] = 0
  return(prob)
}

# check
# dnbinom(   1, size=2,   mu=3)
# my_dnbinom(1, alpha=1/2,mu=3)

##################################################################################
# R has built-in random number generators for the binomial distribution,
# but they are expressed in different form than the form in the Lloyd-Smith
# PLoS paper. This function translates the mu and alpha parameters
# into the format needed by R to generate the NB random numbers
##################################################################################
my_rnbinom=function(n,mu,alpha){
  size = 1/alpha
  prob = size/(mu+size)
  return(rnbinom(n,size=size,prob=prob))
}





```


Column {.sidebar}
-----------------------------------------------------------------------

```{r}

library(shiny)
library(utf8)

sliderInput('mu', 'common  \u03BC', 18,
              min = 1, max = 25,step=.5,ticks=F)

sliderInput('alpha_a', '\u03B1 for red curve', value = c(.1),
              min = 0, max = 5 ,step=0.01, ticks=F)

sliderInput('alpha_b', '\u03B1 for dark blue curve', value = c(0.01),
              min = 0, max = 5 ,step=0.01, ticks=F)

sliderInput('alpha_d', '\u03B1 for purple curve', value = c(1),
              min = 0, max = 5 ,step=0.01, ticks=F)

sliderInput('sims', 'simulations', 50000,
              min = 50000, max = 500000,step=50000,ticks=F)

sliderInput('x_range', 'Plot x-range', value = c(0,40),
        min = 0, max = 80,step=5,ticks=F)

sliderInput('y_range', 'Plot y-range', value = c(0,.1),
        min = 0, max = 1,step=.05,ticks=F)

 

```

Illustrating negative binomial distributions for various values of
both the mean and $\alpha$. When $\alpha$ = 1, the negative binomial distribution takes the form of a
geometric distribution, which is the discrete correlate of the continuous negative
exponential distribution. 
The negative binomial distribution with $\alpha$ = 0 is Poisson.
As the mean increases, the probability of
a zero decreases, and the more the shape approximates a Gaussian distribution.
As the Poisson mean gets larger it approaches normality, the negative binomial distribution does not respond to larger mean values in that manner. 

 

Column {data-width=400}
-----------------------------------------------------------------------
### xxxxxx

```{r}

renderPlot({
  
 
require("sfsmisc")
#set.seed(28754) # set random number seed for reproducibilty of results

##################################################################################
# Define the Negative Binomial probability density function, with parameters
# mu and alpha
# The mean of this NB distribution is mu, and variance is sigma^2=mu+alpha*mu^2
##################################################################################

##################################################################################
# Now let's try out the NB density function, and overlay the Poisson
# distribution with the same mean
##################################################################################
#mult.fig(2) # divide the plotting area up into 2 (one up and one down)

# mu = sample(1:25,1)
# alpha_a = 0.1
# alpha_b = .01
# alpha_d = 1

  mu = input$mu
  alpha_a = input$alpha_a
  alpha_b =  input$alpha_b
  alpha_d =  input$alpha_d
  
  low =  input$x_range[1]
  high=  input$x_range[2]
  xmax = high
  
  ymax = input$y_range[2]

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  # if else turn neg binomial into poisson if alpha =0
  x=c(-0.0001,seq(0,xmax,1))
  
  y =          dpois(x,mu)
   
  if(alpha_a==0) {
  yb =          dpois(x,mu)
  }else{
  yb=     my_dnbinom(x,mu,alpha_a)
  }
  
  if(alpha_b==0){
  yc =          dpois(x,mu)
  }else{
  yc=     my_dnbinom(x,mu,alpha_b)
  }
  
  if(alpha_d==0){
  yd =          dpois(x,mu)
  }else{
  yd=     my_dnbinom(x,mu,alpha_d)
  }
  
  nor <-       dnorm(x, mu, sqrt(mu))


  x=append(0,x)  
  y=append(0,y)
  yb=append(0,yb)
  yc=append(0,yc)
  yd=append(0,yd)
  nor=append(0,nor)
  
  l = !is.na(y+yb+yc+yd+nor)
  
  plot(x[l],y[l],ylim=c(0,ymax),xlim=c(low,xmax),type="l",lwd=lwd.,xlab="x",
       ylab="prob(x)",main="Probability distributions")
  
  lines(x[l],yb[l], col=2,lwd=lwd.,type="l")
  lines(x[l],yc[l], col=4,lwd=lwd.,type="l")
  lines(x[l],nor[l],col=5,lwd=lwd.,type="l")
  lines(x[l],yd[l], col=6,lwd=lwd.,type="l")
   
  # https://stackoverflow.com/questions/6044800/adding-greek-character-to-axis-title
  apois = paste("Poisson \u03BC=",mu,sep="")
  anegbinom_a = paste("Neg Binom \u03BC=",mu," \u03B1=",alpha_a,sep="")
  anegbinom_b = paste("Neg Binom \u03BC=",mu," \u03B1=",alpha_b,sep="")
  anegbinom_c = paste("Normal \u03BC=",   mu," \u03C3=sqrt(",mu,")",sep="")
  anegbinom_d = paste("Neg Binom \u03BC=",mu," \u03B1=",alpha_d,sep="")
  
  
  legend("topright",col=c(1,2,4,6,5),legend=c(apois,anegbinom_a,anegbinom_b, anegbinom_d, anegbinom_c),
         lwd=lwd.,bty="n")
 }
)




```


### Chart 3

```{r}

 
```

Column {data-width=400}
-------------------------------------

### Chart 3

```{r}

renderPlot({
  

    n=input$sims
    
    mu = input$mu
    alpha_a =  input$alpha_a
    alpha_b =  input$alpha_b
    alpha_d =  input$alpha_d
    
    low =  input$x_range[1]
    high=  input$x_range[2]
    xmax = high
    
    ymax = input$y_range[2]
    
    z  =      rpois(n,mu)
    zb = my_rnbinom(n,mu,alpha_a)
    zc = my_rnbinom(n,mu,alpha_b)
    zd =      rnorm(n,mu,sqrt(mu))
    ze = my_rnbinom(n,mu,alpha_d)
    
    a=hist(z, plot=F,breaks=seq(-1.5,n+.5,1))
    b=hist(zb,plot=F,breaks=seq(-1.5,n+.5,1))
    c=hist(zc,plot=F,breaks=seq(-1.5,n+.5,1))
    d=hist(zd,plot=F,breaks=200)
    e=hist(ze,plot=F,breaks=seq(-1.5,n+.5,1))
    
    atitle = paste("Distributions of",n,"random numbers")
    
    plot(a$mids,a$density,type="s",lwd=lwd.,col=1,ylim=c(0,ymax),main=atitle,xlim=c(low,xmax),
         xlab="x",ylab="Fraction falling within each bin")
    
    lines(b$mids,b$density,type="s",lwd=lwd.,col=2)
    lines(c$mids,c$density,type="s",lwd=lwd.,col=4)
    lines(d$mids,d$density,type="s",lwd=lwd.,col=5)
    lines(e$mids,e$density,type="s",lwd=lwd.,col=6)
    
    apois = paste("Poisson \u03BC=",mu,sep="")
    anegbinom_a = paste("Neg Binom \u03BC=",mu," \u03B1=",alpha_a,sep="")
    anegbinom_b = paste("Neg Binom \u03BC=",mu," \u03B1=",alpha_b,sep="")
    anegbinom_c = paste("Normal \u03BC=",   mu," \u03C3=sqrt(",mu,")",sep="")
    anegbinom_d = paste("Neg Binom \u03BC=",mu," \u03B1=",alpha_d,sep="")
    
    legend("topright",col=c(1,2,4,6,5),legend=c(apois,anegbinom_a,anegbinom_b, anegbinom_d, anegbinom_c),
           lwd=lwd.,bty="n")


})

```

### Chart 4

```{r}



```
More
===


 
 The binomial distribution describes the number of successes in n trials, the geometric distribution describes the number
of failures before the first success, r, and the negative binomial distribution
describes the number of failures before the rth success. p194

The only restriction placed on α is that it take positive rational values,
rarely above 4 p190

the app uses alpha. 
When alpha=0, k is large and poisson emerges
When alpha>1, k is vanishingly small , k <1 higly overdispersed (alpha big)
Underdispersed data were assigned the minimum value of alpha, corresponding to k -> infinity.


a = 1/k

k =1/a

Accordingly, all calculations
in this study were conducted using a, but all results and discussion
are posed in terms of k

Confusingly, the term ‘dispersion parameter’ can refer to either k or a; other terms for k include ‘shape
parameter’ and ‘clustering coefficient’.

In this study ML estimation was conducted for the parameter a,
but results are reported in terms of k ˆ = 1/aˆ because k is more
familiar to epidemiologists and ecologists. Estimates of aˆ were
restricted to positive values, because the allowed range for k was
(0,infity). 



